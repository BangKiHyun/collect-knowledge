##싱글톤 패턴

####싱글톤 패턴이란

- 전역 변수를 사용하지 않고 객체를 하나만 생성 하도록 하여, 생성된 객체를 어디에서든지 참조할 수 있도록 하는 패턴
- Singleton calss는 하나의 인스턴스만을 생성하는 책임이 있으며 getInstance() 같은 메서드를 통해 모든 클라이언트에게 동일한 인스턴스를 반환하는 작업을 수행한다.



####예시

- JdbcTemplate

```
public class JdbcTemplate {
    private static JdbcTemplate jdbcTemplate;

    public static JdbcTemplate getInstance() {
        if (jdbcTemplate == null) {
            jdbcTemplate = new JdbcTemplate();
        }
        return jdbcTemplate;
    }
 }
```

- JdbcTemplate 클래스의 생성자를 private으로 선언하여 외부에서 호출할 없게 해야한다.
- JdbcTemplate 클래스에 대한 인스턴스를 하나 만들어 제공해줄 메서드가 필요하다.
  - static 메서드로 getInstance()를 만들어 동일한 인스턴스를 반환하게 한다.



####문제점

다중 스레드에서 JdbcTemplate 클래스를 이용할 때 인스턴스가 1개 이상 생성되는 경우가 발생할 수 있다.

- *경합 조건(Race Condition)을 발생시키는 경우
  1. JdbcTemplate 인스턴스가 아직 생성되지 않았을 때 스레드 1이 getInstance 메서드의 if문을 실행해 이미 인스턴스가 생성되었는지 확인한다. 현재 jdbcTemplate 인스턴스는 null인 상태다.
  2. 만약 스레드 1이 생성자를 호출해 인스턴스를 만들기 전 스레드 2가 if문을 실행해 jdbcTemplate 인스턴스가 null인지 확인한다. 현재 jdbcTemplate인스턴스는 null이므로 인스턴스를 생서하는 생성자를 호출하는 코드를 실행하게 된다.
  3. 스레드 1도 스레드 2와 마찬가지로 인스턴스를 생성하는 코드를 실행하게 되면 결과적으로 JdbcTemplate 클래스의 인스턴스가 2개 생성된다.
- 경합 조건
  - 메모리와 같은 동일한 자원ㅇ르 2개 이상의 스레드가 이용하려고 경합하는 현상



해결책

1. 정적 변수에 인스턴스를 만들어 바로 초기화하는 방법

   ```
   public class JdbcTemplate {
   
       private static JdbcTemplate jdbcTemplate = new JdbcTemplate();
   
       private JdbcTemplate() {};
   
       public static JdbcTemplate getInstance() {
           return jdbcTemplate;
       }
   }
   ```

   - static 변수
     - 객체가 생성되기 전 클래스가 메모리에 로딩될 때 만들어져 초기화가 한 번만 실행
     - 프로그램이 종료될 때 까지 없어지지 않고 메모리에 계속 상주하며 클래스에서 생성된 모든 객체에서 참조할 수 있다.

2. 인스턴스를 만드는 메서드에 동기화하는 방법

       public class JdbcTemplate {
       
           private static JdbcTemplate jdbcTemplate = null;
           private int counter = 0;
           private JdbcTemplate() {};
       
       		//인스턴스를 만드는 메서드 동기화(임계 구역)
           public syschronized static JdbcTemplate getInstance() {
               if(jdbcTemplate == null){
               	jdbcTemplate = new JdbcTemplate();
               }
               return jdbcTemplate;
           }
           
           public void operate(String str){
           	//오직 하나의 스레드만 접근을 허용함(임계 구역)
           	//성능을 위해 필요한 부분만을 임계 구역으로 설정한다.
           	sysnchronized(this) {
           		counter++;
           		System.out.println(str + counter);
           	}
           }
       }

- 인스턴스를 만드는 메서드를 임계 구역으로 변경
  - 다중 스레드 환경에서 동시에 여러 스레드가 getInstance 메서드를 소유하는 객체에 접근하는 것을 방지한다.
- 공유 변수에 접근하는 부분을 임계 구역으로 변경
  - 여러 개의 스레드가 하나뿐인 counter 변수 값에 동시에 접근해 갱신하는 것을 방지한다.
- getInstance()에 Lock을 하는 방식이라 성능저하가 발생한다.



3. 정적 클래스

   ```
   public class JdbcTemplate {
   		private static int counter = 0;
   		// 메서드 동기화 (임계 구역)
   		public syschronized static void operate(String str) {
           counter++;
           System.out.println(str + counter);
       }
   }
   ```

- 차이점
  - 정적 클래스를 이용하면 객체를 전혀 생성하지 않고 메서드를 사용한다.
  - 정적 메서드를 사용하므로 일번적으로 실행할 때 바인딩되는 인스턴스 메서드를 사용하는 것보다 성능 면에서 우수하다.
- 정적 클래스를 사용할 수 없는 경우
  - 인트페이스를 구현해야 하는 경우, 정적 메서드는 인터페이스에서 사용할 수 없다.



Singleton을 구현하는 것 중 가장 좋은 방법은 Enum Class를 사용하는 것이다. 아래 링크는 Enum Class가 무엇인지 알려준다.
https://github.com/BangKiHyun/collect-knowledge/blob/master/Java/Enum.md

